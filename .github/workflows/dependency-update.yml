name: ğŸ”„ Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: "3.12"

jobs:
  update-dependencies:
    name: ğŸ”„ Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš¡ Install uv
        uses: astral-sh/setup-uv@v3

      - name: ğŸ”„ Update dependencies
        run: |
          uv sync --all-extras --upgrade

      - name: ğŸ§ª Test with updated dependencies
        run: |
          uv sync --all-extras
          uv pip install -e .
          make check
          make test

      - name: ğŸ“ Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'â¬†ï¸ Update dependencies'
          title: 'â¬†ï¸ Weekly dependency updates'
          body: |
            ## ğŸ”„ Automated Dependency Updates
            
            This PR contains weekly dependency updates generated automatically.
            
            ### ğŸ“¦ Changes
            - Updated all dependencies to their latest compatible versions
            - Dependencies resolved using latest available versions
            
            ### âœ… Validation
            - All quality checks passed
            - Test suite runs successfully
            - No breaking changes detected
            
            ### ğŸ” Review Notes
            Please review the changes and ensure:
            - No unexpected version bumps
            - All tests continue to pass
            - No new security vulnerabilities
            
            ---
            *This PR was automatically generated by the dependency update workflow.*
          branch: 'automated/dependency-updates'
          labels: |
            dependencies
            automated
          assignees: |
            ${{ github.actor }}

  security-audit:
    name: ğŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš¡ Install uv
        uses: astral-sh/setup-uv@v3

      - name: ğŸ“¦ Install dependencies
        run: uv sync --all-extras

      - name: ğŸ›¡ï¸ Run security audit
        run: |
          uv run --all-extras pip-audit --desc --output=json --out=security-report.json
        continue-on-error: true

      - name: ğŸ“¤ Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

      - name: ğŸ“Š Security Summary
        run: |
          if [ -f security-report.json ]; then
            echo "ğŸ›¡ï¸ Security audit completed"
            echo "ğŸ“‹ Report available in artifacts"
          else
            echo "âœ… No security issues found"
          fi
