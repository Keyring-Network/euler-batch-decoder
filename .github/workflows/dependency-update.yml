name: 🔄 Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: "3.12"

jobs:
  update-dependencies:
    name: 🔄 Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ⚡ Install uv
        uses: astral-sh/setup-uv@v3

      - name: 🔄 Update dependencies
        run: |
          uv sync --all-extras --upgrade

      - name: 🧪 Test with updated dependencies
        run: |
          uv sync --all-extras
          uv pip install -e .
          make check
          make test

      - name: 📝 Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: '⬆️ Update dependencies'
          title: '⬆️ Weekly dependency updates'
          body: |
            ## 🔄 Automated Dependency Updates
            
            This PR contains weekly dependency updates generated automatically.
            
            ### 📦 Changes
            - Updated all dependencies to their latest compatible versions
            - Dependencies resolved using latest available versions
            
            ### ✅ Validation
            - All quality checks passed
            - Test suite runs successfully
            - No breaking changes detected
            
            ### 🔍 Review Notes
            Please review the changes and ensure:
            - No unexpected version bumps
            - All tests continue to pass
            - No new security vulnerabilities
            
            ---
            *This PR was automatically generated by the dependency update workflow.*
          branch: 'automated/dependency-updates'
          labels: |
            dependencies
            automated
          assignees: |
            ${{ github.actor }}

  security-audit:
    name: 🛡️ Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ⚡ Install uv
        uses: astral-sh/setup-uv@v3

      - name: 📦 Install dependencies
        run: uv sync --all-extras

      - name: 🛡️ Run security audit
        run: |
          uv run --all-extras pip-audit --desc --output=json --out=security-report.json
        continue-on-error: true

      - name: 📤 Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

      - name: 📊 Security Summary
        run: |
          if [ -f security-report.json ]; then
            echo "🛡️ Security audit completed"
            echo "📋 Report available in artifacts"
          else
            echo "✅ No security issues found"
          fi
